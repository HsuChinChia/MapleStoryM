<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <!-- import CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
</head>

<body>

    <div id="app">

        <div class="container p-2">
            <div class="row">
                <div class="col-12 text-center">
                    <h2 style="color:#F56C6C">說喀就喀 寵物抽獎體驗中心</h2>



                    <!--   top buttons -->
                    <template>
                        <el-button @click="addItem">新增物品</el-button>
                        <el-button @click="showTestDialog">測試</el-button>
                        <el-button type="primary" @click="showGetItemMessage">開獎</el-button>
                    </template>

                    <!--   the main ui -->
                    <template>
                        <h1>機率設定</h1>
                        <!--     <el-input-number v-model="chanceInputStep"> </el-input-number> -->
                        <el-table :data="tableData" style="width: 100%">
                            </el-table-column>
                            <el-table-column label="物品名稱" width="180">
                                <template slot-scope="scope">
                                    <el-input v-model="scope.row.name" />
                                </template>
                            </el-table-column>
                            <el-table-column label="機率">
                                <template slot-scope="scope">
                                    <span style="margin-left: 10px">{{ scope.row.p }}%</span>
                                    <el-input-number style="margin-left:8px" v-model="scope.row.p"
                                        controls-position="right" :step="0.01"
                                        @change="(newValue) => {countTotalChance(newValue, scope.$index)}">
                                    </el-input-number>

                                </template>
                            </el-table-column>
                        </el-table>
                    </template>

                    <!--  the test dialog -->
                    <el-dialog title="測試抽獎機率" :visible.sync="testDialogVisible" width="80%" center>
                        <div style="text-align:center;">
                            <span>要測試幾次呢？</span>

                            <el-input-number v-model="testTimes" controls-position="right">
                            </el-input-number>
                            <div class="testprogress">
                                <el-progress type="circle" :percentage="testPercentage"
                                    :status="testPercentage >= 100 ? 'success' : ''"></el-progress>
                            </div>
                            <pre v-if="runnningTest">{{ testMessage }}</pre>
                            <div v-if="testResult.length > 0 && runnningTest === false">
                                <h2>測試結果</h2>
                                <el-table :data="testResult" style="width: 100%">
                                    <el-table-column prop="name" label="物品名稱">
                                    </el-table-column>
                                    <el-table-column prop="count" label="出現次數">
                                    </el-table-column>
                                    <el-table-column prop="chance" label="出現機率">
                                    </el-table-column>
                                    <el-table-column prop="chanceBySetting" label="設定的機率">
                                    </el-table-column>
                                </el-table>
                            </div>
                        </div>
                        <span slot="footer" class="dialog-footer">
                            <el-button @click="testDialogVisible = false">取消</el-button>
                            <el-button type="primary" @click="startTest">開始</el-button>
                        </span>
                    </el-dialog>

                </div>
            </div>
        </div>

    </div>

</body>


<!-- import Vue before Element -->
<script src="https://unpkg.com/vue/dist/vue.js"></script>
<!-- import JavaScript -->
<script src="https://unpkg.com/element-ui/lib/index.js"></script>



<script>
    var app = new Vue({
        el: '#app',
        data: {
            // p means Probability, init data
            tableData: [
                {
                    name: "[奇蹟黑]普蘭交換",
                    p: 3.32
                },
                {
                    name: "[奇蹟黑]普林交換",
                    p: 3.32
                }, {
                    name: "[奇蹟黑]小雪熊交換",
                    p: 3.32
                }, {
                    name: "[奇蹟藍]狗狗交換",
                    p: 9.80
                }, {
                    name: "[奇蹟藍]喵喵交換",
                    p: 9.80
                }, {
                    name: "[奇蹟藍]倉鼠交換",
                    p: 9.80
                }, {
                    name: "[奇蹟銀]辣魚交換",
                    p: 12.00
                }, {
                    name: "[奇蹟銀]威特貝里交換",
                    p: 12.00
                },
                {
                    name: "奇蹟黑生命之水",
                    p: 6.64
                },
                {
                    name: "優質生命水(15天)3個",
                    p: 7
                }, {
                    name: "有機食品20個",
                    p: 11.55
                }, {
                    name: "有機食品30個",
                    p: 11.45
                },
            ],
            testTimes: 10000,
            testMessage: "waiting for test...",
            runnningTest: true,
            runnningTestDone: false,
            testResult: [],
            testDialogVisible: false,
            chanceInputStep: 0.1,
            testPercentage: 0
        },
        methods: {
            showTestDialog() {
                // just reset data
                this.testMessage = "waiting for test...";
                this.runnningTest = true;
                this.testResult = [];
                this.testDialogVisible = true;
                this.testPercentage = 0;
            },
            startTest() {
                // setup variables
                this.runnningTest = true;
                this.testResult = [];
                this.testPercentage = 0;
                var chance = {};
                this.tableData.forEach((i) => {
                    chance[i.name] = 0;
                });

                var i = 0;
                // run in next tick (after vue view updated)
                this.$nextTick(() => {
                    var interval = setInterval(() => {
                        if (i === this.testTimes) {
                            clearInterval(interval);
                            this.runnningTest = false;
                            // create test result
                            Object.keys(chance).forEach((_, index) => {
                                this.testResult.push({
                                    name: _,
                                    count: chance[_],
                                    chance: Math.round((chance[_] / this.testTimes) * 100) + "%",
                                    chanceBySetting: this.tableData[index].p + "%"
                                });
                            });
                        } else {
                            // get the item, render testMessage update chance coutner
                            const item = this.getItemByChange();
                            chance[item.name]++;
                            // this.testMessage = JSON.stringify(item, null, 4);
                            this.testMessage = item;
                            i++;
                        }
                        // update the progress bar
                        this.testPercentage = parseInt((i / this.testTimes) * 100);
                    }, 1);
                });
            },
            // add new item to the list
            addItem() {
                this.tableData.push({
                    name: "new Item",
                    p: 0
                });
            },
            // put the item on the number line and check if on the range
            getItemByChange() {
                const r = Math.random() * 100;
                console.log('r', r);
                let count = 0;
                let item;
                // 從第一個開始排，看哪個會到隨機數字，有到他的範圍抽出來內的話，就抽出來

                for (let i = 0; i < this.tableData.length; i++) {
                    let _ = this.tableData[i];
                    // console.log("count", r, count, count + _.p);
                    // 假設 r 是 0.7, 第一圈判斷開始
                    // 0.7 >= 0 && 0.7 <= 0 + 0.5
                    // return false 下一圈
                    // 0.7 >= 0.5 && 0.7 <= 0.8(count = count + _.p) 上一圈判斷失敗加的
                    // return true 找到了！
                    if (r >= count && r <= count + _.p) {
                        // yes, it's in range!
                        item = _;
                        break;
                    } else {
                        // not in range, going to next loop
                        count = count + _.p;
                    }
                }
                return item;
            },
            showGetItemMessage() {
                const item = this.getItemByChange();
                this.$confirm(
                    `您抽到的是 『${item.name}』, 他有 ${item.p}%的機率被抽中`,
                    "開獎囉！",
                    {
                        confirmButtonText: "再抽一次",
                        cancelButtonText: "取消"
                        // type: "warning"
                    }
                ).then(() => {
                    this.showGetItemMessage();
                });
            },
            getNextAvaiableItemIndex(currentIndex) {
                let index = currentIndex - 1;
                if (index < 0) index = this.tableData.length - 1;

                if (this.tableData[index].p <= 0) {
                    index--;
                }

                return index;
            },
            // when the value changed, we must make sure the sum of items chance is "1"
            countTotalChance(value, index) {
                var total = 0;
                this.tableData.forEach((_) => {
                    total += _.p;
                });
                var number_to_plus = (number_to_plus = 1 - total);
                number_to_plus = parseFloat(number_to_plus.toFixed(4));

                let next_index = this.getNextAvaiableItemIndex(index);
                this.tableData[next_index].p = Number(
                    (this.tableData[next_index].p + number_to_plus).toFixed(4)
                );
            }

        },
        mounted() {

        }

    })

</script>

<style>
    ul {
        list-style: none;
    }

    .testprogress {
        margin-top: 1em;
        text-align: center;
    }

    pre {
        margin-top: 1em;
        text-align: left;
    }
</style>



<!-- Optional JavaScript; choose one of the two! -->

<!-- Option 1: jQuery and Bootstrap Bundle (includes Popper) -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>
<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
        crossorigin="anonymous"></script> -->

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">









<!-- Option 2: jQuery, Popper.js, and Bootstrap JS
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s" crossorigin="anonymous"></script>
    -->

</html>